syntax = "proto3";

package capabilities.llo.v1;

import "tools/generator/v1alpha/cre_metadata.proto";

option go_package = "github.com/smartcontractkit/chainlink-common/pkg/capabilities/v2/actions/llo";

// Configuration for the LLO Transmit Action
message Config {
  // The ID of the DON (Decentralized Oracle Network)
  uint32 don_id = 1;

  // Mercury server configurations (legacy support)
  // Map of server URL to public key (32 bytes hex)
  map<string, bytes> servers = 2;

  // Transmitter-specific configurations
  repeated TransmitterConfig transmitters = 3;

  // Enable verbose logging for debugging
  bool verbose_logging = 4;
}

// Configuration for a specific transmitter type
message TransmitterConfig {
  // Type of transmitter (e.g., "cre", "mercury")
  string type = 1;

  // Transmitter-specific options as JSON
  bytes opts = 2;
}

// Input for transmitting an LLO report
message Request {
  // Configuration digest for the OCR round
  bytes config_digest = 1;

  // Sequence number of the report
  uint64 seq_nr = 2;

  // The report bytes to transmit
  bytes report = 3;

  // Report metadata
  ReportInfo report_info = 4;

  // Attributed onchain signatures
  repeated AttributedSignature signatures = 5;
}

// Metadata about the report
message ReportInfo {
  // Lifecycle stage (e.g., production, staging, retirement)
  string life_cycle_stage = 1;

  // Report format identifier
  string report_format = 2;
}

// An attributed onchain signature
message AttributedSignature {
  // The signature bytes
  bytes signature = 1;

  // The signer index
  uint32 signer = 2;
}

// Response after transmitting a report
message Response {
  // Whether the transmission was successful
  bool success = 1;

  // Error message if transmission failed
  string error = 2;

  // Number of sub-transmitters that successfully transmitted
  uint32 successful_transmissions = 3;

  // Number of sub-transmitters that failed
  uint32 failed_transmissions = 4;

  // Details about each sub-transmitter's result
  repeated TransmitterResult transmitter_results = 5;
}

// Result from a specific transmitter
message TransmitterResult {
  // Transmitter type
  string type = 1;

  // Success status
  bool success = 2;

  // Error message if failed
  string error = 3;
}

// LLO Transmit Action service definition
service LLOTransmit {
  option (tools.generator.v1alpha.capability) = {
    mode: MODE_DON
    capability_id: "llo-transmit@1.0.0"
  };

  // Transmit an LLO report to configured destinations
  rpc Execute(Request) returns (Response);
}
