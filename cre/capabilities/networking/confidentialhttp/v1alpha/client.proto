syntax = "proto3";

package capabilities.networking.confidentialhttp.v1alpha;

import "google/protobuf/duration.proto";
import "tools/generator/v1alpha/cre_metadata.proto";

message SecretIdentifier {
  string key = 1;
  string namespace = 2;
  optional string owner = 3;
}

// HeaderValues represents multiple values for a single header key.
message HeaderValues {
  repeated string values = 1;
}

// HTTPRequest contains the HTTP fields used to make a request from the enclave.
message HTTPRequest {
  // url is the endpoint to which the request is sent.
  string url = 1;
  // method is the HTTP method (GET, POST, PUT, DELETE, etc.).
  string method = 2;
  // body is the request body - either a string template or raw bytes.
  oneof body {
    string body_string = 3;
    bytes body_bytes = 8;
  }
  // headers are the request headers as name-value pairs.
  // Supports multiple values per header key.
  map<string, HeaderValues> headers = 4;
  // template_public_values are public values used to fill in request body and header templates.
  map<string, string> template_public_values = 5;
  // custom_root_ca_cert_pem is an optional custom root CA certificate (PEM format)
  // for verifying the external server's TLS certificate.
  bytes custom_root_ca_cert_pem = 6;
  // timeout is the request timeout duration.
  google.protobuf.Duration timeout = 7;
}

// HTTPResponse contains the HTTP response from the enclave.
message HTTPResponse {
  // status_code is the HTTP status code.
  uint32 status_code = 1;
  // body is the response body.
  bytes body = 2;
  // headers are the response headers.
  // Supports multiple values per header key.
  map<string, HeaderValues> headers = 3;
}

// ConfidentialHTTPRequest is the input provided to the confidential HTTP capability.
// It combines an HTTPRequest with secrets from VaultDON.
message ConfidentialHTTPRequest {
  repeated SecretIdentifier vault_don_secrets = 1;
  HTTPRequest request = 2;
  // encrypt_output controls whether the enclave response should be encrypted.
  // If true and a secret named "san_marino_aes_gcm_encryption_key" is provided,
  // the response will be AES-GCM encrypted using that key.
  // If true and no such key is provided, the response will be TDH2 encrypted
  // using the VaultDON master public key.
  // Default is false (response returned unencrypted).
  bool encrypt_output = 3;
}

service Client {
  option (tools.generator.v1alpha.capability) = {
    mode: MODE_NODE
    capability_id: "confidential-http@1.0.0-alpha"
  };

  rpc SendRequest(ConfidentialHTTPRequest) returns (HTTPResponse);
}
