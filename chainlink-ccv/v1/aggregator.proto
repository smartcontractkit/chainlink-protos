syntax = "proto3";

package chainlink_ccv.v1;

import "google/rpc/status.proto";

option go_package = "github.com/smartcontractkit/chainlink-protos/chainlink-ccv/go/v1";

service Aggregator {
  rpc WriteCommitteeVerifierNodeResult(WriteCommitteeVerifierNodeResultRequest) returns (WriteCommitteeVerifierNodeResultResponse);
  rpc BatchWriteCommitteeVerifierNodeResult(BatchWriteCommitteeVerifierNodeResultRequest) returns (BatchWriteCommitteeVerifierNodeResultResponse);
  rpc ReadCommitteeVerifierNodeResult(ReadCommitteeVerifierNodeResultRequest) returns (ReadCommitteeVerifierNodeResultResponse);
  rpc WriteChainStatus(WriteChainStatusRequest) returns (WriteChainStatusResponse);
  rpc ReadChainStatus(ReadChainStatusRequest) returns (ReadChainStatusResponse);
}

service MessageDiscovery {
  rpc GetMessagesSince(GetMessagesSinceRequest) returns (GetMessagesSinceResponse);
}

service VerifierResultAPI {
  rpc GetVerifierResultsForMessage(GetVerifierResultsForMessageRequest) returns (GetVerifierResultsForMessageResponse);
}

message ChainStatus {
  uint64 chain_selector = 1;
  uint64 finalized_block_height = 2;
  bool disabled = 3;
}

message WriteChainStatusRequest {
  repeated ChainStatus statuses = 1;
}

message WriteChainStatusResponse {
  WriteStatus status = 1;
}

message ReadChainStatusRequest {
  repeated uint64 chain_selectors = 1;
}

message ReadChainStatusResponse {
  repeated ChainStatus statuses = 1;
}

message Message {
  bytes sender = 1;
  bytes data = 2;
  bytes on_ramp_address = 3;
  bytes token_transfer = 4;
  bytes off_ramp_address = 5;
  bytes dest_blob = 6;
  bytes receiver = 7;
  uint64 source_chain_selector = 8;
  uint64 dest_chain_selector = 9;
  uint64 sequence_number = 10;
  uint32 execution_gas_limit = 11;
  uint32 ccip_receive_gas_limit = 12;
  uint32 finality = 13;
  bytes ccv_and_executor_hash = 14;
  uint32 dest_blob_length = 15;
  uint32 token_transfer_length = 16;
  uint32 data_length = 17;
  uint32 receiver_length = 18;
  uint32 sender_length = 19;
  uint32 version = 20;
  uint32 off_ramp_address_length = 21;
  uint32 on_ramp_address_length = 22;
}

message CommitteeVerifierNodeResult {
  // Message data that the CCV node attests to
  Message message = 1;
  // Version of the CCV found from the receipt blob on the source chain
  bytes ccv_version = 2;
  // Addresses of the CCV specified for this message
  repeated bytes ccv_addresses = 3;
  // Address of the preferred executor
  bytes executor_address = 4; 
  // Node signature. Will be combined with other node signatures to reach quorum and for the final verifer result
  bytes signature = 5;
}

message VerifierResult {
  // Message data 
  Message message = 1;
  // Addresses of the CCV specified for this message
  repeated bytes message_ccv_addresses = 2;
  // Address of the preferred executor
  bytes message_executor_address = 3;
  // Verification data required to execute the message on the destination (e.g. signatures)
  bytes ccv_data = 4;
  VerifierResultMetadata metadata = 5;  
}

message VerifierResultMetadata {  
  // Timestamp when the verifier result was created  
  int64 timestamp = 1;  
  // Execution hint so that executors can easily verify before writing on chain 
  bytes verifier_dest_address = 2;  
} 


message VerifierResultWithSequence {  
  // Verifier result contains the message data and required verification data from the committee verifier  
  VerifierResult verifierResult = 1;  
  // Monotonic sequence number assigned by the verifier result API. Can be used to query for new messages since a given sequence.  
  int64 sequence = 2;  
}

message BatchWriteCommitteeVerifierNodeResultRequest {
  repeated WriteCommitteeVerifierNodeResultRequest requests = 1;
}

message BatchWriteCommitteeVerifierNodeResultResponse {
  repeated WriteCommitteeVerifierNodeResultResponse responses = 1;
  repeated google.rpc.Status errors = 2;
}

message WriteCommitteeVerifierNodeResultRequest {
  CommitteeVerifierNodeResult committee_verifier_node_result = 1;
}

enum WriteStatus {
  SUCCESS = 0;
  FAILED = 1;
}

message WriteCommitteeVerifierNodeResultResponse {
  WriteStatus status = 1;
}

message ReadCommitteeVerifierNodeResultRequest {
  bytes message_id = 1;
  bytes address = 2;
}

message ReadCommitteeVerifierNodeResultResponse {
  CommitteeVerifierNodeResult committee_verifier_node_result = 1;
}

message GetVerifierResultsForMessageRequest {
  repeated bytes message_ids = 1;
}

message GetVerifierResultsForMessageResponse {
  repeated VerifierResult results = 1;
  repeated google.rpc.Status errors = 2;
}

message GetMessagesSinceRequest {
    int64 sinceSequence = 1;
}

message GetMessagesSinceResponse {
    repeated VerifierResultWithSequence results = 1;
}